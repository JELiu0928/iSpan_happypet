<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- 使用CDN引入bootstrap-icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=LXGW+WenKai+TC:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../../css/bootstrap.min.css">
    <!-- 後台header -->
    <link rel="stylesheet" href="../../css/back_header_footer.css">
    <link rel="stylesheet" href="../../css/detail_info.css">

    <script src="../../js/bootstrap.bundle.js"></script>
    <script src="../../js/jquery-3.7.1.js"></script>
    
    <title>產品詳細資訊</title>
    <style>
        
    </style>
</head>
<body>
    <header class="w-100 position-sticky">
        <div class="row m-0 px-md-5 text-center justify-content-lg-between justify-content-center align-items-center">
            <a href="" class="col-lg-3 col-8"><img class="img-fluid logo" src="../../img/LOGO.png" alt=""></a>
            <ul class="nav col-lg-9 p-0 d-flex justify-content-lg-between justify-content-center">
                <li class="col-lg-2 col-3 dropdown">
                    <a href="" data-toggle="dropdown" class="dropdown-toggle" role="button" id="beauty"
                        data-bs-toggle="dropdown" aria-expanded="false">美容預約</a>
                    <ul class="dropdown-menu" aria-labelledby="beauty">
                        <li><a href="" class="dropdown-item">美容預約表</a></li>
                    </ul>
                </li>
                <li class="col-lg-2 col-3 dropdown">
                    <a href="" data-toggle="dropdown" class="dropdown-toggle" role="button" id="beauty"
                        data-bs-toggle="dropdown" aria-expanded="false">寵物住宿</a>
                    <ul class="dropdown-menu" aria-labelledby="beauty">
                        <li><a href="" class="dropdown-item">旅館訂單</a></li>
                        <li><a href="" class="dropdown-item">當日住宿</a></li>
                    </ul>
                </li>
                <li class="col-lg-2 col-3 dropdown">
                    <a href="" data-toggle="dropdown" class="dropdown-toggle" role="button" id="beauty"
                        data-bs-toggle="dropdown" aria-expanded="false">產品專區</a>
                    <ul class="dropdown-menu" aria-labelledby="beauty">
                        <li><a href="http://localhost/petx/test/info.html" class="dropdown-item">產品主要內容</a></li>
                        <li><a href="http://localhost/petx/test/detail.html" class="dropdown-item">產品詳細資訊</a></li>
                        <li><a href="" class="dropdown-item">產品入庫</a></li>
                        <li><a href="" class="dropdown-item">上架中產品</a></li>
                        <li><a href="" class="dropdown-item">未上架產品</a></li>
                    </ul>
                </li>
                <li class="col-lg-2 col-3 dropdown">
                    <a href="" data-toggle="dropdown" class="dropdown-toggle" role="button" id="beauty"
                        data-bs-toggle="dropdown" aria-expanded="false">產品訂單</a>
                    <ul class="dropdown-menu" aria-labelledby="beauty">
                        <li><a href="" class="dropdown-item">美容預約表</a></li>
                    </ul>
                </li>
                <div class="nav_icon col-lg-2 ">
                    <a href="">登出</a>
                </div>
            </ul>
        </div>
    </header>
    <div class=" pdDetailContainer position-relative py-3">
        <h2 class="m-0 py-3">產品詳細資訊</h2>

        <button id="addBtn"> + 新增</button>
        <form id="myPd" method="post" enctype="multipart/form-data" class="position-relative">
            <table class="table border " >
                <tr class="querySeriesID">
                    <th>產品系列編號<i class="bi bi-arrow-clockwise refreshBtn"></i></th>
                    <td class="border "><input class="" type="text" name="pdSeries"></td>
                    <th>產品系列名稱</th>
                    <td class="border "><input class="" id="pdName" type="text" name="pdName" disabled></td>
                </tr>
            </table>
            <table id="addTable" class="table table-striped align-middle table-bordered text-center">
                <thead>
                    <tr>
                        <th >料號</th>
                        <th >口味</th>
                        <th >淨重</th>
                        <th >尺寸</th>
                        <th >款式</th>
                        <th >價格</th>
                        <th >GTIN</th>
                        <!-- <th >產品敘述</th> -->
                        <!-- <th >操作</th> -->
                    </tr>
                </thead>
                <tbody id="newItem">
                    <tr class="pd_row ">
                        <td class="pd_id_area position-relative">
                            <button class="position-absolute deleteBtn"><i class="bi bi-x"></i></button>
                            <!-- <input class="seriesNum" type="text" disabled> -->
                            <input class="pdID" type="text" form="myPd">
                            <input type="text" name="fullID[]" class="fullPdID" form="myPd" readonly>
                        </td>
                        <td><input type="text" name="flavor[]" form="myPd"></td>
                        <td><input type="text" name="weight[]" form="myPd"></td>
                        <td><input type="text" name="size[]" form="myPd"></td>
                        <td><input type="text" name="color[]" form="myPd"></td>
                        <td><input type="text" name="price[]" form="myPd"></td>
                        <td><input type="text" name="GTIN[]" form="myPd"></td>
                        <!-- <td><input type="text" name="description[]" form="myPd"></td> -->
                        <!-- <td >
                            <i class="bi bi-check2-circle checkBtn"></i>
                            <i class="bi bi-pencil-square updateBtn"></i>
                        </td> -->
                    </tr>
                </tbody>
            </table>
        </form>
        <div class="d-flex justify-content-end">
            <button id="insertBtn" form="myPd" >新增至資料庫</button>
        </div>

    </div>
    <!-- 彈出視窗 -->
        <!-- Modal -->
        <div class="modal fade " id="myModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-body">
                    <p id="alertMsg" class="m-0"></p>
                </div>
                <div class="modal-footer">
                <button type="button" class="btn" data-bs-dismiss="modal">確認</button>
                </div>
            </div>
            </div>
        </div>
    

        <script src="../../js/detail_info.js"></script>
    <!-- <script>
        // window.addEventListener('DOMContentLoaded',function(){

        window.onload = ()=>{
            let myModal = document.getElementById('myModal')
            let myInput = document.getElementById('myInput')

            // myModal.addEventListener('shown.bs.modal', function () {
            //     myInput.focus()
            // })
            function showMsg(msg){
                $('#myModal').modal('show')
                $('#alertMsg').text(msg)
            }

            let pdSeries = document.querySelector('[name="pdSeries"]')
            // let seriesInputs = document.querySelectorAll('input.seriesNum')
            // --------------點選後readonly -------start---------------------------
            // let checkBtn = document.querySelectorAll('.checkBtn')
            // let updateBtn = document.querySelectorAll('.updateBtn')
            // newItem.addEventListener('click',function(event){
            //     console.log('event.target = ',event.target)
            //     // 匹配特定選擇器且離當前元素最近的祖先元素（也可以是當前元素本身）
            //     let pdRow = event.target.closest('.pd_row')
            //     console.log('pdRow',pdRow)
                
            //     if(event.target.classList.contains('checkBtn')){
            //         let inputs = pdRow.querySelectorAll('input')
            //         inputs.forEach(function(input){
            //             input.name !== 'fullID[]' ?  input.setAttribute('readonly', true) : "";
            //         })
            //         console.log('hi')
            //     }else if(event.target.classList.contains('updateBtn')){
            //         // alert(123)
            //         let inputs = pdRow.querySelectorAll('input')
            //         inputs.forEach(function(input){
            //             input.name !== 'fullID[]' ?  input.removeAttribute('readonly') : "";
            //         })
            //     }
            // })
            // --------------點選後readonly -------end---------------------------

         

            $('[name="pdSeries"]').on('change',function(event){
                event.preventDefault();
                // console.log('我是產品系列的this',this.value)
               fetchData();
               
            })
            // 查詢系列號的系列名
            function fetchData(){
                // fetch('detail.php',{
                // let formData = new FormData(document.getElementById('myPd'));
                // formData.append('action', 'fetch');
                // fetch('insertDetail.php',{
                let pdSeries = document.querySelector('[name="pdSeries"]').value;
                fetch('http://localhost/testpet/public/api/product_back/detail/show',{
                    method:'post',
                    headers:{
                        'Content-Type': 'application/json'
                    },
                    body:JSON.stringify({pdSeries })
                    // body:formData
                })
                .then(response=>{
                    // console.log(response)
                    // return response.text()   //圖片
                    return response.json()  //陣列
                })
                .then(dataObj=>{
                    console.log(dataObj)
                    // ds202407001
                    // 插入系列名
                    // dataObj.name === undefined ? showMsg('查無此商品')  : pdName.value = obj.name

                    if(!dataObj.name){
                        showMsg(dataObj.error)
                        pdName.value = ''
                        $('input.fullPdID').each(function(index,fullInput){
                        // fullPdIDInputs.forEach(fullInput => {
                            fullInput.value = ''
                        });
                    }else{
                        pdName.value = dataObj.name
                    }

                    // console.log('obj.name型態',typeof obj.name)
                    
                 
                    // $('input.fullPdID').each(function(index,fullInput){
                    // // fullPdIDInputs.forEach(fullInput => {
                    //     fullInput.value = obj.id 
                    // });
                    
                })
                .catch(error => {
                    showMsg(error.error)
                });
            }
          

            // ---------------------------------------------------
            // 取得系列號與user輸入值，串接後放入fullID
            function getNum(){
                let pdIDInputs = document.querySelectorAll('input.pdID')
                let fullPdIDInputs = document.querySelectorAll('input.fullPdID')

                pdIDInputs.forEach(function(pdIDInput,index) {
                    pdIDInput.addEventListener('input', function(){
                    
                    console.log('我是pdSeries.value',pdSeries.value)
                        // pdSeries.value.trim() === undefined ? fullPdIDInputs[index].value = '' : fullPdIDInputs[index].value
                        // pdSeries.value != undefined ? fullPdIDInputs[index].value = pdSeries.value.trim() + pdIDInput.value.trim() : fullPdIDInputs[index].value = ''
                        fullPdIDInputs[index].value = pdSeries.value.trim() + pdIDInput.value.trim()

                    })
                });
            }
            getNum()
            // ---------------------------------------------------

            let refreshBtn = document.querySelector('.refreshBtn')
            refreshBtn.onclick = ()=>{
                let inputs = document.querySelectorAll('input')    

                inputs.forEach((input)=>{
                    input.value = ""
                })
            }


          // pdIDInputs.forEach((pdIDInput, index) => {
            //     pdIDInput.addEventListener('input', () => {
            //         let seriesValue = seriesInputs[index].value.trim();
            //         let pdIDValue = pdIDInput.value.trim();
            //         fullPdIDInputs[index].value = seriesValue + pdIDValue;
            //     });
            // });

            // 綁定父元素
            newItem.addEventListener('click',function(event){
                let deleteBtn = event.target.closest('.deleteBtn')
                event.preventDefault()
                // 匹配特定選擇器且離當前元素最近的祖先元素（也可以是當前元素本身）
                // let pdRow = event.target.closest('.pd_row')
                let pdRow = deleteBtn.closest('.pd_row')
                // console.log('pdRow',pdRow)
                // console.log('event.target = ',event.target)
                pdRow.remove()
              
            })
            addBtn.addEventListener("click",(event)=>{
                event.preventDefault();

                document.getElementById("newItem").insertAdjacentHTML("beforeend",
                    `
                    <tr class="pd_row">
                        <td class="pd_id_area position-relative"> 
                            <button class="position-absolute deleteBtn"><i class="bi bi-x"></i></button>
                            <input class="pdID" type="text" form="myPd">
                            <input type="text" name="fullID[]" class="fullPdID" form="myPd" readonly>
                        </td>
                        <td><input type="text" name="flavor[]" form="myPd"></td>
                        <td><input type="text" name="weight[]" form="myPd"></td>
                        <td><input type="text" name="size[]" form="myPd"></td>
                        <td><input type="text" name="color[]" form="myPd"></td>
                        <td><input type="text" name="price[]" form="myPd"></td>
                        <td><input type="text" name="GTIN[]" form="myPd"></td>
                    </tr>
                    `
                ) 
                // document.querySelector('.seriesNum').value = obj.id;
                getNum()
            })
            
            // document.getElementById('insertBtn').onclick = (event)=>{
            $('#insertBtn').click((event)=>{
                event.preventDefault();
                let formData = new FormData(document.getElementById('myPd'));
                // formData.append('action', 'insert');

                // 產品insert至資料庫
                // fetch('insertDetail.php',{
                fetch('http://localhost/testpet/public/api/product_back/detail/create',{
                    method:'post',
                    body:formData
                    // body:new FormData(myPd)
                })
                .then(response=>{
                    // return response.text()  
                    console.log('我是點選insert後的response',response)
                    console.log('response的content-type',response.headers.get('content-type'))
                    if (!response.ok) {
                        throw new Error('Network response was not ok ' + response.statusText);
                    }
                    return response.json()  
                    // return response.text()  
                })
                .then(data=>{
                    console.log('data',data)
                    if (data.message) {
                        console.log(data.message);
                        showMsg(data.message)

                        setTimeout(()=>{
                            location.reload()// 刷新頁面
                        },1000)
                    } else if (data.error) {
                        console.log('Error:', data.error);
                        // alert(data.error)
                        showMsg(data.error)
                    }
                })
                .catch(error => {
                    // console.error('Error:', error);
                    // alert('Error:', error);
                    showMsg(error)
                    
                });
            })

            // fetchBtn.onclick = ()=>{
            //     fetch('fetchDetail.php',{
            //         method:'post',
                   
            //     }).then(response=>{ 
            //         return response.json()  
            //     })
            //     .then(data=>{
            //         console.log('我是查詢出來的',data)
            //     })
            // }
            

        }
    // })

    </script> -->
</body>
</html>