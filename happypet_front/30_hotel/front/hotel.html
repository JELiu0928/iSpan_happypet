<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>好寵你 | 寵物全方位服務網站</title>

    <link rel="stylesheet" href="../../css/bootstrap.min.css" />
    <link rel="stylesheet" href="../../css/header_footer.css" />
    <link rel="stylesheet" href="../../css/hotel_front.css" />
    <!-- 引用flatpickr -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
    />

    <!-- 使用CDN引入bootstrap-icons -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />

    <!-- 字型字體 -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=LXGW+WenKai+TC:wght@300;400;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
    />
    <!-- 引用flatpickr -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/zh.js"></script>
    <script src="../../js/flatpickr.js"></script>
    <script src="../../js/bootstrap.bundle.js"></script>
  </head>
  <body>
    <!-- nav -->
    <header id="navbar" class="sticky-top">
      <div class="member nav_icon">
        <a href="#"><i class="bi-person"></i></a>
        <a href="#"><i class="bi-cart"></i></a>
      </div>
      <div class="row align-items-center container-xl">
        <div
          class="text-center col-xxl-3 col-xl-3 col-lg-12 col-md-12 col-ms-12 col-12"
        >
          <a class="" href="#">
            <img class="nav-logo m-2" src="../../img/LOGO.png" alt="" />
          </a>
        </div>
        <div class="col-xxl-9 col-xl-9 col-lg-12 col-md-12 col-ms-12 col-12">
          <ul class="nav justify-content-center text-center">
            <li class="col-3 mt-3 mb-3">
              <a class="p-2" href="#">美容預約</a>
            </li>
            <li class="col-3 mt-3 mb-3">
              <a class="p-2" href="./hotel.html">寵物住宿</a>
            </li>
            <li class="col-3 mt-3 mb-3">
              <a class="p-2" href="#">產品專區</a>
            </li>
            <li class="col-3 mt-3 mb-3">
              <a class="p-2" href="#">獸醫門診</a>
            </li>
          </ul>
        </div>
      </div>
    </header>
    <div class="image-container text-center fw-bold">
      <img
        src="../../img/30_hotel/banner .jpg"
        alt="寵物住宿"
        class="hotelimg img-fluid opacity-50"
      />
      <div class="centered-text fw-bold">寵物住宿</div>
    </div>

    <!-- calendar & search -->
    <div
      class="myCalendar d-flex justify-content-center align-items-center mt-3"
    >
      <form method="post" id="searchForm" class="d-flex align-items-center">
        <div class="input-icon me-2">
          <i class="bi bi-calendar"></i>
          <input
            id="checkin"
            type="date"
            name="checkin"
            class="form-control-lg border-0 date-box-shadow"
            placeholder="選擇入住日期"
          />
        </div>
        <div class="input-icon me-2">
          <i class="bi bi-calendar"></i>
          <input
            id="checkout"
            type="date"
            name="checkout"
            class="form-control-lg border-0 date-box-shadow"
            placeholder="選擇退房日期"
          />
        </div>
        <button type="submit" id="searchBtn" class="fs-5 align-items-center">
          搜尋 <i class="bi bi-search"></i>
        </button>
      </form>
    </div>
    <div id="roomAvailabilityResults" class="mt-4"></div>

    <div class="container">
      <div class="row">
        <!-- hotel -->
        <div class="ps-5 col-9">
          <div
            class="col-12 pt-3 pb-5 room-info-container"
            id="availabilityResults1"
          ></div>

          <div
            class="col-12 pt-3 pb-5 room-info-container"
            id="availabilityResults2"
          ></div>

          <div
            class="col-12 pt-3 pb-5 room-info-container"
            id="availabilityResults3"
          ></div>

          <div
            class="col-12 pt-3 pb-5 room-info-container"
            id="availabilityResults4"
          ></div>
        </div>
        <!-- shoppingcar -->
        <div class="col-md-3 order-md-last order-1">
          <div class="shoppingcarfixed container pt-3 pb-5 p-1">
            <div class="row">
              <div class="myshopping col-12 text-center lh-sm">
                <p class="text-secondary fw-bold fs-4 mt-2">我的購物車</p>
                <hr />
                <span class="fs-5 text-start">
                  <p id="hotelName">產品名稱:</p>
                  <p id="hotelPetName">寵物名稱:</p>
                  <p id="checkinDisplay">入住日期:</p>
                  <p id="checkoutDisplay">退房日期:</p>
                  <p id="nightdayDisplay">晚數:</p>
                  <p id="hotelCartQuantity">數量:</p>
                  <p id="hotelCartPrice">房價:</p>
                  <p id="sameRoomCount">同房數(隻):</p>
                  <p id="sameroomNightday">同房晚數:</p>
                  <p id="sameRoomPrice">同房價:</p>
                </span>
                <hr />
                <p class="fs-5 mb-1 d-flex justify-content-between">
                  <span>總金額:</span>
                  <span id="roomTotal"></span>
                </p>
                <div class="text-end">
                  <button
                    class="mb-3 btn btn-secondary opacity-75"
                    onclick="window.location.href='hotelorder.html'"
                  >
                    立即訂房
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // shoppingcarfixed
      document.addEventListener("scroll", function () {
        const shoppingCar = document.querySelector(".shoppingcarfixed");
        const footer = document.querySelector("footer");

        const footerRect = footer.getBoundingClientRect(); //傳回元素的大小及其相對於視口的位置
        const shoppingCarRect = shoppingCar.getBoundingClientRect();
        const offsetTop = window.pageYOffset + shoppingCarRect.top;
        const stickyTop = 85; // 這是你設定的 sticky 的頂部距離

        // 當購物車區塊的底部接近 footer 的頂部
        if (shoppingCarRect.bottom > footerRect.top) {
          shoppingCar.style.position = "absolute";
          shoppingCar.style.top = `${
            footerRect.top + window.scrollY - shoppingCarRect.height
          }px`;
        } else {
          shoppingCar.style.position = "sticky";
          shoppingCar.style.top = `${stickyTop}px`;
        }
      });

      // 選日期更新購物車日期跟計算晚數
      document.addEventListener("DOMContentLoaded", function () {
        const checkinInput = document.getElementById("checkin");
        const checkoutInput = document.getElementById("checkout");
        const checkinDisplay = document.getElementById("checkinDisplay");
        const checkoutDisplay = document.getElementById("checkoutDisplay");
        const nightdayDisplay = document.getElementById("nightdayDisplay");
        const sameroomNightday = document.getElementById("sameroomNightday");

        function calculateNights() {
          const checkinDate = new Date(checkinInput.value);
          const checkoutDate = new Date(checkoutInput.value);
          const timeDifference = checkoutDate - checkinDate;
          const daysDifference = timeDifference / (1000 * 3600 * 24);
          const daysDifference2 = timeDifference / (1000 * 3600 * 24);

          if (!isNaN(daysDifference) && daysDifference > 0) {
            checkinDisplay.textContent = `入住日期: ${checkinInput.value}`;
            checkoutDisplay.textContent = `退房日期: ${checkoutInput.value}`;
            nightdayDisplay.textContent = `晚數: ${daysDifference}`;
            sameroomNightday.textContent = `同房晚數: ${daysDifference2}`;
          } else {
            nightdayDisplay.textContent = "晚數: ";
            sameroomNightday.textContent = "同房晚數: ";
          }
        }

        checkinInput.addEventListener("change", calculateNights);
        checkoutInput.addEventListener("change", calculateNights);
      });

      // 找空房正確版
      document.addEventListener("DOMContentLoaded", function () {
        const resultsContainers = {
          深景房: document.getElementById("availabilityResults1"),
          奢華房: document.getElementById("availabilityResults2"),
          總統房: document.getElementById("availabilityResults3"),
          喵皇房: document.getElementById("availabilityResults4"),
        };

        const rooms = [
          {
            type: "深景房",
            imageSrc: "../../img/30_hotel/product1.jpg",
            roomPrice: "$400",
            sameroom: "$100",
          },
          {
            type: "奢華房",
            imageSrc: "../../img/30_hotel/product2.webp",
            roomPrice: "$600",
            sameroom: "$150",
          },
          {
            type: "總統房",
            imageSrc: "../../img/30_hotel/product3.jpg",
            roomPrice: "$900",
            sameroom: "$200",
          },
          {
            type: "喵皇房",
            imageSrc: "../../img/30_hotel/product4.jpg",
            roomPrice: "$500",
            sameroom: "$100",
          },
        ];

        function renderRooms(roomData) {
          // 清除之前的內容
          Object.values(resultsContainers).forEach((container) => {
            container.innerHTML = "";
          });

          roomData.forEach((room) => {
            let priceTableHTML;

            if (room.type === "喵皇房") {
              priceTableHTML = `
                <div class="col-lg-7 col-md-12 col-sm-12 text-center price-table-container">
                    <table id="priceTable" class="table">
                        <thead id="mythead" class="fs-5">
                            <tr>
                              <th class="text-light">房型</th>
                              <th class="text-light">喵皇房</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="custom-table">
                              <td class="text-light">最多可住宿隻數</td>
                              <td>三隻貓貓</td>
                            </tr>
                            <tr class="custom-table">
                              <td class="text-light">房價(一晚)</td>
                              <td>$500</td>
                            </tr>
                            <tr class="custom-table">
                              <td class="text-light">同房價(隻)</td>
                              <td>$100</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                `;
            } else {
              priceTableHTML = `
                <div class="col-lg-7 col-md-12 col-sm-12 text-center price-table-container">
                    <table id="priceTable" class="table">
                        <thead id="mythead" class="fs-5">
                            <tr>
                              <th class="text-light">房型</th>
                              <th class="text-light">深景房</th>
                              <th class="text-light">奢華房</th>
                              <th class="text-light">總統房</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="custom-table">
                              <td class="text-light">最多可住宿隻數</td>
                              <td>兩隻小型犬</td>
                              <td>三隻小型犬<br />一隻中型犬<br />一隻小型犬&一隻中型犬</td>
                              <td>一隻大型犬<br />四隻小型犬<br />兩隻中型犬</td>
                            </tr>
                            <tr class="custom-table">
                              <td class="text-light">房價(一晚)</td>
                              <td>$400</td>
                              <td>$600</td>
                              <td>$900</td>
                            </tr>
                            <tr class="custom-table">
                              <td class="text-light">同房價(隻)</td>
                              <td>$100</td>
                              <td>$150</td>
                              <td>$200</td>
                            </tr>
                            <thead id="mythead" class="fs-5">
                              <th class="text-light fs-5" colspan="4">住宿限制</th>
                            </thead>
                            <tr class="custom-table">
                              <td class="text-light">體重</td>
                              <td>小型犬<br />10kg以下</td>
                              <td>中型犬<br />10~20kg</td>
                              <td>大型犬<br />20~40kg</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                `;
            }

            const roomHTML = `
            <div class="row justify-content-center">
                <div class="col-lg-5 col-md-12 col-sm-12 d-flex justify-content-center pe-5">
                    <div class="myProduct product-container border border-secondary border-opacity-25 border-2 rounded-2 position-relative">
                        <div id="myProductimg" class="text-center mb-3 mt-0">
                            <img src="${room.imageSrc}" alt="${room.type}" class="img-fluid" />
                            <p class="room">
                                <span class="fw-bold fs-4 text-light">${room.type}</span>
                            </p>
                        </div>
                        <div class="d-flex align-items-center fs-5">
                            <button class="choose ms-2 p-2" data-room-type="${room.type}">選擇寵物</button>
                            <div class="pet-container ms-3"></div>
                        </div>
                        <div class="quantity-container mt-3 ms-2 fs-5">
                            <label for="productQuantity${room.type}">數量:</label>
                            <input type="number" value="1" min="1" max="3" class="hotelQuantity" id="hotelQuantity${room.type}" />
                        </div>
                        <div class="mt-3 ms-2 fs-5">
                            <p>房價：${room.roomPrice}</p>
                        </div>
                        <div class="mt-3 ms-2 fs-5">
                            <p>同房價：${room.sameroom}</p>
                        </div>
                        <div class="text-end">
                            <button class="btn btn-outline-secondary opacity-75 position-absolute bottom-0 end-0 m-3 btn-lg addToCartBtn" data-room-type="${room.type}" data-room-price="${room.roomPrice}">
                                加入購物車
                            </button>
                        </div>
                    </div>
                </div>
                ${priceTableHTML}
            </div>`;

            // 將房型 HTML 插入到對應的容器中
            const container = resultsContainers[room.type];
            if (container) {
              container.innerHTML = roomHTML;
            }
          });

          // 綁定 "選擇寵物" 按鈕的事件監聽器
          const chooseButtons = document.querySelectorAll(".choose");
          chooseButtons.forEach((button) => {
            button.addEventListener("click", function () {
              // 取得當前按鈕所在的容器
              const petContainer = button.nextElementSibling;

              // 發送 AJAX 請求獲取 UID 3 的寵物名稱
              fetch("http://localhost/happypet_back/public/api/hotel_user_pets")
                .then((response) => {
                  if (!response.ok) {
                    throw new Error("Network response was not ok");
                  }
                  return response.json();
                })
                .then((data) => {
                  // 清空之前的內容
                  petContainer.innerHTML = "";

                  // 動態生成勾選框和 label
                  const petNames = data.map((pet) => pet.pet_name);
                  petNames.forEach((petName, index) => {
                    const petCheckboxHTML = `
                        <div class="form-check ms-3">
                            <input class="form-check-input pet-checkbox" type="checkbox" value="${petName}" id="petCheckbox${index}" />
                            <label class="form-check-label" for="petCheckbox${index}">
                                ${petName}
                            </label>
                        </div>`;
                    petContainer.innerHTML += petCheckboxHTML;
                  });

                  // 綁定勾選框的事件監聽器
                  const petCheckboxes =
                    petContainer.querySelectorAll(".pet-checkbox");
                  petCheckboxes.forEach((checkbox) => {
                    checkbox.addEventListener("change", updateSameRoomCount);
                  });
                });
            });
          });

          // // 更新寵物名稱和購物車數量
          // function updateSameRoomCount() {
          //   // 獲取所有勾選中的勾選框
          //   const selectedCheckboxes = document.querySelectorAll(
          //     ".pet-checkbox:checked"
          //   );
          //   const sameRoomCountElement =
          //     document.getElementById("sameRoomCount");

          //   // 如果勾選多於一個寵物，從1開始累加；如果只勾選一個，顯示0
          //   const sameRoomCount =
          //     selectedCheckboxes.length > 1 ? selectedCheckboxes.length - 1 : 0;

          //   // 更新同房數
          //   if (sameRoomCountElement) {
          //     sameRoomCountElement.textContent = `同房數: ${sameRoomCount}`;
          //   }
          // }

          // 待測試-同房數跟同房價*
          function updateSameRoomCount() {
            // 獲取所有勾選中的勾選框
            const selectedCheckboxes = document.querySelectorAll(
              ".pet-checkbox:checked"
            );
            const sameRoomCountElement =
              document.getElementById("sameRoomCount");
            const sameRoomPriceElement =
              document.getElementById("sameRoomPrice");

            // 如果勾選多於一個寵物，從1開始累加；如果只勾選一個，顯示0
            const sameRoomCount =
              selectedCheckboxes.length > 1 ? selectedCheckboxes.length - 1 : 0;

            // 更新同房數
            if (sameRoomCountElement) {
              sameRoomCountElement.textContent = `同房數: ${sameRoomCount}`;
            }

            // 取得當前房型
            const roomType = selectedCheckboxes[0]
              ?.closest(".product-container")
              .querySelector(".room")
              .textContent.trim();

            // 更新同房價
            if (sameRoomPriceElement) {
              if (sameRoomCount === 0) {
                sameRoomPriceElement.textContent = "同房價: $0";
              } else {
                const room = rooms.find((r) => r.type === roomType);
                const sameRoomPrice =
                  parseInt(room.sameroom.replace("$", "")) * sameRoomCount;
                sameRoomPriceElement.textContent = `同房價: $${sameRoomPrice}`;
              }
            }
          }

          // 更新總金額的函數
          function updateCartTotal() {
            const nightCountText =
              document.getElementById("nightdayDisplay")?.textContent || "0";
            const quantityText =
              document.getElementById("hotelCartQuantity")?.textContent || "0";
            const roomPriceText =
              document.getElementById("hotelCartPrice")?.textContent || "0";
            const sameRoomCountText =
              document.getElementById("sameRoomCount")?.textContent || "0";
            const sameRoomPriceText =
              document.getElementById("sameRoomPrice")?.textContent || "0";

            // 提取數字部分
            const nightCount =
              parseInt(nightCountText.replace("晚數:", "").trim()) || 0;
            const quantity =
              parseInt(quantityText.replace("數量:", "").trim()) || 0;
            const roomPrice =
              parseInt(
                roomPriceText.replace("房價:", "").replace("$", "").trim()
              ) || 0;
            const sameRoomCount =
              parseInt(sameRoomCountText.replace("同房數(隻):", "").trim()) ||
              0;
            const sameRoomPrice =
              parseInt(
                sameRoomPriceText.replace("同房價:", "").replace("$", "").trim()
              ) || 0;

            // 計算總金額
            const totalPrice =
              nightCount * quantity * roomPrice +
              sameRoomCount * sameRoomPrice * nightCount;

            // 格式化總金額讓他變 NT$x,xxx
            const formattedTotalPrice = totalPrice.toLocaleString("en-US");

            // 更新總金額顯示
            document.getElementById(
              "roomTotal"
            ).textContent = `NT$${formattedTotalPrice}`;
          }

          // 綁定 "加入購物車" 按鈕的事件監聽器
          const addToCartButtons = document.querySelectorAll(".addToCartBtn");
          addToCartButtons.forEach((button) => {
            button.addEventListener("click", function () {
              // 取得房型和房價
              const roomType = button.getAttribute("data-room-type");
              const roomPrice = button.getAttribute("data-room-price");

              const productContainer = button.closest(".product-container");
              if (productContainer) {
                const selectedQuantity =
                  productContainer.querySelector(".hotelQuantity");
                const selectedPets = Array.from(
                  productContainer.querySelectorAll(".pet-checkbox:checked")
                )
                  .map((checkbox) => checkbox.value)
                  .join(", ");

                if (selectedQuantity) {
                  const quantity = selectedQuantity.value;

                  // 更新產品名稱
                  const hotelNameElement = document.getElementById("hotelName");
                  if (hotelNameElement) {
                    hotelNameElement.textContent = `產品名稱: ${roomType}`;
                  }

                  // 更新購物車數量
                  const cartQuantityElement =
                    document.getElementById("hotelCartQuantity");
                  if (cartQuantityElement) {
                    cartQuantityElement.textContent = `數量: ${quantity}`;
                  }

                  // 更新購物車房價
                  const cartPriceElement =
                    document.getElementById("hotelCartPrice");
                  if (cartPriceElement) {
                    cartPriceElement.textContent = `房價: ${roomPrice}`;
                  }

                  // 更新購物車寵物名稱
                  const cartPetsElement =
                    document.getElementById("hotelPetName");
                  if (cartPetsElement) {
                    cartPetsElement.textContent = `入住寵物: ${selectedPets}`;
                  }

                  // 更新購物車總金額
                  updateCartTotal();
                }
              }
            });
          });
        }

        function fetchAndRenderRooms(query = "") {
          fetch(
            `http://localhost/happypet_back/public/api/check-availability${query}`,
            {
              method: "GET",
              headers: {
                "Content-Type": "application/json",
              },
            }
          )
            .then((response) => response.json())
            .then((data) => {
              if (data.room_availability.length === 0) {
                Object.values(resultsContainers).forEach((container) => {
                  container.innerHTML = "<p>沒有空房，請重新選擇日期！</p>";
                });
              } else {
                const availableRooms = rooms.filter((room) =>
                  data.room_availability.some(
                    (r) => r.room_type === room.type && r.available_rooms > 0
                  )
                );
                renderRooms(availableRooms);
              }
            })
            .catch((error) => {
              console.error("發生錯誤：", error);
              Object.values(resultsContainers).forEach((container) => {
                container.innerHTML = "<p>發生錯誤，請稍後再試。</p>";
              });
            });
        }

        // 頁面加載時顯示所有房間
        renderRooms(rooms);

        document
          .getElementById("searchForm")
          .addEventListener("submit", function (event) {
            event.preventDefault(); // 防止表單提交

            const checkinDate = document.getElementById("checkin").value;
            const checkoutDate = document.getElementById("checkout").value;

            const query = `?checkin=${encodeURIComponent(
              checkinDate
            )}&checkout=${encodeURIComponent(checkoutDate)}`;
            fetchAndRenderRooms(query);
          });
      });

      // 設置入住和退房日期的最小值
      const today = new Date().toISOString().split("T")[0];
      const checkin = document.getElementById("checkin");
      const checkout = document.getElementById("checkout");

      checkin.setAttribute("min", today);

      checkin.addEventListener("change", function () {
        const checkinDate = new Date(checkin.value);
        const checkoutDate = new Date(checkout.value);

        if (checkinDate < new Date(today)) {
          alert("入住日期不能早於今天，請重新選擇！");
          checkin.value = "";
          checkout.value = "";
          checkout.setAttribute("min", today);
        } else {
          checkout.setAttribute("min", checkin.value);
        }

        if (checkoutDate && checkoutDate < checkinDate) {
          alert("入住日期不能晚於退房日期，請重新選擇！");
          checkin.value = "";
          checkout.value = "";
        }
      });

      checkout.addEventListener("change", function () {
        const checkinDate = new Date(checkin.value);
        const checkoutDate = new Date(checkout.value);

        if (checkinDate && checkoutDate < checkinDate) {
          alert("退房日期不能早於入住日期，請重新選擇！");
          checkin.value = "";
          checkout.value = "";
        }
      });
    </script>
    <!--------------- footer ---------------->

    <footer>
      <div
        class="row text-center justify-content-center mt-4 align-items-center"
      >
        <a href="#" class="col-xl-4 col-lg-5 col-md-10 col-10 p-2">
          <img class="logo" src="../../img/LOGO.png" alt="" />
        </a>

        <ul
          class="footer_contact col-xl-4 col-lg-5 col-md-10 col-10 text-lg-start text-center p-4"
        >
          <li>0800-123-456</li>
          <li>service@gmail.com</li>
          <li>特定寵物業許可證號：特寵業字第s1110005號</li>

          <div class="footer_icon">
            <span class=""
              ><a href=""><i class="bi bi-instagram"></i></a
            ></span>
            <span class=""
              ><a href=""><i class="bi bi-line"></i></a
            ></span>
            <span class=""
              ><a href=""><i class="bi bi-facebook"></i></a
            ></span>
          </div>
        </ul>
        <p class="copyright text-center mt-2">
          <a href="#">服務條款及隱私保護政策 | </a
          >&copy;此網站為練習使用，不做商業用途
        </p>
      </div>

      <div class="d-flex">
        <img
          class="footer_img col-12 col-sm-12 col-md-8 col-xl-8 col-xxl-8"
          src="../../img/00_index/資產-40.png"
          alt=""
        />
        <img
          class="footer_stamp"
          src="../../img/00_index/transparent01.png"
          alt=""
        />
      </div>
    </footer>
  </body>
</html>
